{{> addProductForm }}
{{> productList }}
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script>
    let socket = io();
    const form = document.getElementById('productForm');
    const tableContainer = document.querySelector('.tableContainer');

    const updateProductList = (product) => {
        const table = tableContainer.querySelector('.productTable')
        const markup = `
            <tr>
                <td>${product.title}</td>
                <td>${product.price}</td>
                <td><img src=${product.thumbnail} alt="" /></td>
            </tr>
        `
        console.log(table);
        if (table) {
            table.insertAdjacentHTML('beforeend', markup);
        } else {
            tableContainer.innerHTML = '';
            tableContainer.insertAdjacentHTML('afterbegin', `
                <table class="productTable table table-striped">
                    ${markup}
                </table>
            `)
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries([...new FormData(e.target)]);
        const response = await fetch('/api/productos/guardar', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });
        console.log(response.ok);
        if (response.ok)
            socket.emit('product added', JSON.stringify(formData));
    })

    socket.on('product list update', (product) => {
        const parsedProduct = JSON.parse(product);
        updateProductList(parsedProduct);
    })
</script>